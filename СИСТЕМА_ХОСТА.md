# Система хоста (ведущего) в игре

## Определение хоста

**Хост = Создатель комнаты + Ведущий игры**

Хост определяется автоматически следующим образом:

1. **При создании комнаты:**
   - Пользователь, создавший комнату, становится хостом
   - В таблице `game_rooms` поле `host_id` устанавливается равным `user.id` создателя

2. **При присоединении к комнате:**
   - В таблице `game_players` поле `is_host` устанавливается в `true`, если `room.host_id === user.id`
   - Создатель комнаты автоматически присоединяется к своей комнате при первом входе

## Права хоста (ведущего)

Хост имеет следующие права и возможности:

### 1. Управление игрой
- ✅ **Запуск игры** - только хост может запустить игру из лобби
- ✅ **Начало голосования** - только хост может начать фазу голосования
- ✅ **Окончание голосования** - только хост может завершить голосование и исключить игрока
- ✅ **Следующий раунд** - только хост может перейти к следующему раунду

### 2. Управление характеристиками игроков
- ✅ **Обновление характеристик** - хост может изменять характеристики любого игрока
- ✅ **Рандомизация характеристик** - хост может рандомизировать характеристики игрока
- ✅ **Обмен характеристиками** - хост может обменять характеристики между двумя игроками
- ✅ **Раскрытие характеристик** - хост может раскрывать характеристики любых игроков (не только свои)

### 3. Отображение в UI
- В лобби: только хост видит кнопку "Начать игру"
- В игре: хост видит дополнительные кнопки управления (например, "Управление", "Начать голосование")
- В настройках: отображается раздел "Управление (Ведущий)"

## Проверка прав хоста

Все действия хоста проверяются на уровне API:

1. **В API endpoints:**
   ```typescript
   if (room.host_id !== user.id) {
     return NextResponse.json({ error: "Only host can perform this action" }, { status: 403 })
   }
   ```

2. **В базе данных (RLS политики):**
   - Политика "Host can update room" позволяет хосту обновлять настройки комнаты
   - Политика "Host can update any player" позволяет хосту обновлять данные любого игрока

3. **В UI компонентах:**
   ```typescript
   {isHost && (
     <Button onClick={onStartGame}>Начать игру</Button>
   )}
   ```

## Технические детали

### Структура данных

**game_rooms:**
- `host_id` (UUID) - ID пользователя-создателя комнаты

**game_players:**
- `is_host` (BOOLEAN) - флаг, указывающий является ли игрок хостом
- Устанавливается как `room.host_id === user_id` при присоединении

### API Endpoints с проверкой хоста

- `POST /api/game/start` - запуск игры
- `POST /api/game/voting/start` - начало голосования
- `POST /api/game/eliminate` - исключение игрока
- `POST /api/game/round/next` - следующий раунд
- `POST /api/game/characteristics/update` - обновление характеристики
- `POST /api/game/characteristics/randomize` - рандомизация характеристики
- `POST /api/game/characteristics/exchange` - обмен характеристиками

### Автоматическое присоединение

Когда создатель комнаты открывает страницу игры (`/game/[roomCode]`):
1. Система проверяет, присоединен ли пользователь к комнате
2. Если нет - автоматически вызывает `/api/game/join`
3. При присоединении автоматически устанавливается `is_host: true`, если `user.id === room.host_id`

## Важные замечания

1. **Хост не может быть изменен** - после создания комнаты хост остается неизменным
2. **Хост всегда является игроком** - хост должен быть в списке игроков (`game_players`)
3. **Права хоста постоянны** - даже если хост временно покинул игру, его права сохраняются (по `host_id` в таблице комнаты)
