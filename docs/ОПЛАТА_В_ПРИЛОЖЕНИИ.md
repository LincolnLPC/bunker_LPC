# Оплата в приложении «Бункер Онлайн»

## Какой способ оплаты сейчас установлен

В приложении **используется платёжная система Yandex Pay** для оформления премиум-подписки.

- **Создание платежа:** пользователь на странице `/subscription` нажимает «Оформить подписку» → запрос к `/api/payment/create-session` → редирект на страницу оплаты Yandex Pay.
- **Подтверждение оплаты:** после успешной оплаты Yandex Pay отправляет уведомление на **webhook** приложения → обновляются поля `subscription_tier` и `premium_expires_at` в таблице `profiles`.

В коде также есть **обработчик webhook для ЮKassa** (`/api/subscription/webhook`), но создание платежей и интерфейс подписки настроены именно на **Yandex Pay**. Чтобы использовать ЮKassa, потребуется доработка: создание платежей через API ЮKassa и переключение провайдера.

---

## Как подключить Yandex Pay

### 1. Регистрация в Yandex Pay

1. Перейдите на [консоль Yandex Pay](https://console.pay.yandex.ru).
2. Зарегистрируйте магазин и получите:
   - **API-ключ** (секретный),
   - **Merchant ID** (идентификатор магазина).

### 2. Переменные окружения

Скопируйте `env.template` в `.env.local` и добавьте/заполните:

```env
# Платёжный провайдер (по умолчанию yandex-pay)
PAYMENT_PROVIDER=yandex-pay

# Ключ API Yandex Pay (секретный)
YANDEX_PAY_API_KEY=ваш_api_ключ

# ID магазина (публичный, для фронтенда)
NEXT_PUBLIC_YANDEX_PAY_MERCHANT_ID=ваш_merchant_id

# Режим песочницы: true — тесты, false — боевые платежи
YANDEX_PAY_SANDBOX=true

# URL приложения (для редиректа после оплаты)
NEXT_PUBLIC_APP_URL=http://localhost:3000
```

Для production укажите боевой домен, например:

```env
NEXT_PUBLIC_APP_URL=https://ваш-домен.ru
YANDEX_PAY_SANDBOX=false
```

### 3. Callback URL (webhook) в консоли Yandex Pay

Yandex Pay отправляет уведомления о статусе заказа на ваш сервер. Нужно указать **базовый URL приложения** (без пути). Сервис сам добавляет путь `/v1/webhook`.

1. В консоли Yandex Pay откройте настройки магазина (настройки → Callback URL / HTTP-уведомления).
2. Укажите:
   - **Локальная разработка:** используйте туннель (ngrok и т.п.), например `https://ваш-поддомен.ngrok.io`.
   - **Production:** `https://ваш-домен.ru`.

Итоговый URL webhook будет: `https://ваш-домен.ru/v1/webhook`.

### 4. Локальная разработка с webhook

Чтобы получать уведомления от Yandex Pay на локальный сервер:

1. Установите [ngrok](https://ngrok.com/download) или аналог.
2. Запустите приложение: `pnpm dev`.
3. В другом терминале: `ngrok http 3000`.
4. В настройках Callback URL в Yandex Pay укажите выданный ngrok URL (например `https://abc123.ngrok.io`).

### 5. Проверка

1. Запустите приложение и откройте `/subscription`.
2. Войдите в аккаунт и нажмите «Оформить подписку» (например, на месячный план).
3. Должен произойти редирект на Yandex Pay. После успешной оплаты — редирект обратно на `/subscription?success=true`, подписка в профиле должна стать премиум.

Если платёж прошёл, но подписка не обновилась — проверьте логи сервера на запросы к `/v1/webhook` и ошибки при обновлении `profiles`.

---

## Тарифные планы

Настроены в `lib/payment/config.ts`:

| План              | ID                | Цена   | Интервал |
|-------------------|-------------------|--------|----------|
| Премиум (месяц)   | `premium_monthly` | 299 ₽  | месяц    |
| Премиум (год)     | `premium_yearly`  | 2 990 ₽| год      |

Изменение цен или добавление планов — правка объекта `SUBSCRIPTION_PLANS` в `lib/payment/config.ts`.

---

## Дополнительная документация

- **Yandex Pay (интеграция в коде):** `docs/PAYMENT_INTEGRATION.md`
- **Настройка ЮKassa (альтернатива, только webhook):** `docs/YOOKASSA_SETUP.md`
- **Шаблон переменных окружения:** `env.template`
