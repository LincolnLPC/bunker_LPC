# Анализ приложения «Бункер Онлайн»

Полный отчёт: баги, исправления, нереализованный функционал, улучшения и оптимизация.

---

## 1. БАГИ И РЕКОМЕНДУЕМЫЕ ИСПРАВЛЕНИЯ

### Критичные / безопасность

| # | Описание | Где | Рекомендация |
|---|----------|-----|--------------|
| 1 | **Пароль комнаты хранится в открытом виде** | `app/api/game/route.ts` (стр. 197), `app/api/game/join/route.ts` (стр. 229) | Реализовать хеширование (bcrypt/argon2) при создании и проверку при join. |
| 2 | **Типизация `settings` через `as any`** | Множество файлов (game page, use-game-state, API) | Ввести тип `GameSettings` в `types/game.ts` и использовать везде, убрать `(gameState.settings as any)?.gameMode`. |

### WebRTC и медиа

| # | Описание | Где | Рекомендация |
|---|----------|-----|--------------|
| 3 | **Зависимость cleanup от `localStream`** | `hooks/use-webrtc.ts` (useEffect cleanup) | Cleanup при размонтировании не должен зависеть от `localStream`; использовать пустой массив зависимостей или ref для актуального stream. |
| 4 | **Возможная гонка при быстром reconnect** | `use-webrtc.ts` | При ручном «Переподключить видео» и быстром повторном нажатии могут создаваться дубликаты peer. Добавить флаг «reconnect in progress» или debounce. |
| 5 | **Ошибки медиа логируются в консоль несколько раз** | `app/game/[roomCode]/page.tsx` (catch initializeMedia) | Сократить дублирующее логирование (тип, keys, responseData) до одного структурированного лога. |

### Игровая логика и состояние

| # | Описание | Где | Рекомендация |
|---|----------|-----|--------------|
| 6 | **Повторяющееся сообщение "User is already a player, restoring game state"** | `use-game-state.ts` | Логировать не при каждом обновлении комнаты, а один раз при восстановлении после refresh (по флагу или ref). |
| 7 | **Таймер раунда только по клиенту** | `RoundTimer` + `timeRemaining` в page | Если вкладка в фоне, время может расходиться с сервером. Уже есть `roundStartedAt` с сервера — таймер считается от него; при долгом фоне возможен дрифт. | Рассмотреть периодическую синхронизацию с `/api/game/timer/check` для корректировки. |
| 8 | **Нет явной проверки phase при голосовании** | API vote, клиент | Убедиться, что голос принимается только в фазе `voting` и что повторная отправка голоса обрабатывается (идемпотентность или явная ошибка). |

### UI и данные

| # | Описание | Где | Рекомендация |
|---|----------|-----|--------------|
| 9 | **`metadata.cannotVoteAgainst` с разными ключами** | `use-game-state.ts`, SpecialCards | Используются и `playerId`, и `player_id`. Привести к одному формату на API и в трансформе. |
| 10 | **Логи в production** | `use-realtime-game.ts` (Presence state), `use-webrtc.ts` (много console.log) | Обернуть в `logger.debug` / убрать или выводить только в dev. |
| 11 | **Профиль: хардкод URL Supabase в ошибке** | `app/profile/edit/page.tsx` (bucket not found) | Вынести URL или название проекта в env/конфиг. |

### Мелкие

| # | Описание | Рекомендация |
|---|----------|--------------|
| 12 | **@ts-ignore в grant-premium-modal** | Заменить на типизированную обработку ошибки (тип с полем message). |
| 13 | **Обработка ошибок с `(err as any)`** | Ввести тип для ошибок API (например `ApiError { status, message, code }`) и использовать его вместо `as any`. |

---

## 2. ЧТО ЕЩЁ НЕ РЕАЛИЗОВАНО

(По `ПЛАН_РАЗРАБОТКИ.md` и коду.)

### Функциональность

- **Рейтинговая система** — нет рейтинга игроков.
- **Настройки уведомлений** — переключатель в UI есть, бэкенд/пуши не реализованы.
- **Настройки видимости характеристик** (приватные/публичные).
- **TURN-серверы** — только STUN; при жёстком NAT видео может не подключаться.
- **Оптимизация качества видео** под устройство/сеть (Simulcast, ограничение битрейта).
- **Создание уникальных характеристик** ведущим (сейчас только правка существующих).
- **Временные модификации / бонусы-штрафы** в характеристиках.
- **Хеширование пароля комнаты** (в коде помечено TODO).

### Технический долг

- Единый тип **GameSettings** не описан в `types/game.ts` (используется `as any`).
- Нет **E2E-тестов** на критические сценарии (создание комнаты, голосование, медиа).
- **Страница регистрации** (`/auth/signup`) — проверить наличие и сценарий восстановления пароля.

---

## 3. УЛУЧШЕНИЯ ДЛЯ КОРРЕКТНОЙ РАБОТЫ

### Надёжность

1. **Повтор запросов к API**  
   Для критичных вызовов (start, vote, join) при сетевых ошибках — использовать `retry` из `lib/error-handling/connection-recovery.ts` с ограничением попыток.

2. **Обработка потери соединения с Supabase**  
   При обрыве Realtime показывать уведомление «Нет связи» и кнопку «Обновить» или автоматический reconnect с экспоненциальной задержкой.

3. **Валидация ответов API**  
   Проверять форму ответа (например, через zod) для join/start/vote, чтобы при изменении API клиент не падал.

4. **Идемпотентность голоса**  
   На бэкенде: при повторной отправке голоса за того же игрока в том же раунде возвращать 200 без изменения данных.

5. **Таймер раунда**  
   Периодически (например, раз в 30 с) запрашивать `/api/game/timer/check` и при расхождении подстраивать отображаемое время под сервер.

### Медиа и WebRTC

6. **Кнопка «Повторить камеру»**  
   При ошибке камеры (NotReadableError и т.п.) показывать явную кнопку «Повторить подключение камеры» рядом с сообщением об ошибке.

7. **Корректное отключение медиа при уходе**  
   При выходе из комнаты или закрытии вкладки вызывать `leave` API и останавливать все треки локального потока (частично уже есть в cleanup use-webrtc).

8. **Ограничение размера чата в памяти**  
   Хранить в состоянии только последние N сообщений (например, 200), подгружать старые по скроллу вверх при наличии API.

### UX

9. **Индикатор загрузки при старте игры**  
   Пока сервер переводит комнату в `playing`, показывать спиннер/overlay «Игра начинается».

10. **Подтверждение выхода из игры**  
    При нажатии «Покинуть игру» в активной партии — диалог «Вы уверены?».

11. **Доступность (a11y)**  
    Ключевые кнопки (голос, выход, старт) — с `aria-label` и фокусом при открытии модалок.

---

## 4. ОПТИМИЗАЦИЯ

### Производительность

| Область | Что сделать |
|--------|-------------|
| **Рендер страницы игры** | Разбить `page.tsx` на подкомпоненты (секции по фазам), мемоизировать тяжёлые списки (игроки, чат). |
| **useMemo/useCallback** | Проверить зависимости у `playersWithStream`, коллбэков в GameControls и в модалках — лишние пересоздания вызывают лишние рендеры. |
| **Динамический импорт** | Крупные модалки (VotingPanel, VoteResults, BunkerInfo и т.д.) уже подгружаются динамически — оставить как есть. |
| **Realtime** | Фильтровать postgres_changes по нужным полям/таблицам, чтобы не обрабатывать лишние события. |
| **Логи** | В production отключать или сокращать логи WebRTC/GameState (через `logger` и NODE_ENV). |

### Сеть

| Область | Что сделать |
|--------|-------------|
| **Запросы к комнате** | Избежать дублирования: один источник правды (Realtime + начальная загрузка), не дергать лишний раз GET room при каждом действии. |
| **Медиа** | Не вызывать `enumerateDevices` без необходимости; текущая схема (после getUserMedia / по кнопке) — ок. |

### Бандл

| Область | Что сделать |
|--------|-------------|
| **Анализ бандла** | `next build` с анализом (например, `@next/bundle-analyzer`) и проверка тяжёлых зависимостей (recharts, lottie, stripe). |
| **Lazy для редко используемого** | Страницы админки, подписки, профиль — при необходимости подгружать тяжёлые библиотеки по требованию. |

---

## 5. КРАТКИЙ ЧЕКЛИСТ ДЕЙСТВИЙ

**Безопасность:**  
- [ ] Хешировать пароль комнаты при создании и при проверке в join.

**Типизация:**  
- [ ] Ввести `GameSettings` в `types/game.ts` и заменить `(settings as any)`.

**Стабильность:**  
- [ ] Cleanup WebRTC при unmount не завязывать на `localStream`.  
- [ ] Уменьшить шум логов в production (logger + env).  
- [ ] Один раз логировать «restoring game state» при восстановлении игрока.

**UX:**  
- [ ] Кнопка «Повторить камеру» при ошибке медиа.  
- [ ] Подтверждение при выходе из активной игры.

**Оптимизация:**  
- [ ] Мемоизация и разбиение тяжёлой страницы игры.  
- [ ] Проверка лишних подписок Realtime и лишних запросов к API.

Документ можно использовать как дорожную карту: сначала критичные баги и безопасность, затем типобезопасность и логи, после — улучшения UX и оптимизация.
