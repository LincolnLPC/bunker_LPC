# –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –ø–ª–∞—Ç–µ–∂–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã

## –°—Ç–∞—Ç—É—Å

‚úÖ **–ÆKassa –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞** - API endpoints —Å–æ–∑–¥–∞–Ω—ã –∏ –≥–æ—Ç–æ–≤—ã –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é.

### ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ:
- ‚úÖ API endpoint –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø–ª–∞—Ç–µ–∂–µ–π (`/api/payment/create-session`)
- ‚úÖ Webhook endpoint –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–±—ã—Ç–∏–π –ÆKassa (`/api/subscription/webhook`)
- ‚úÖ –°—Ç—Ä–∞–Ω–∏—Ü–∞ –ø–æ–¥–ø–∏—Å–∫–∏ —Å –≤—ã–±–æ—Ä–æ–º —Ç–∞—Ä–∏—Ñ–Ω—ã—Ö –ø–ª–∞–Ω–æ–≤
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç—ã
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ —É—Å–ø–µ—à–Ω–æ–π –∏ –æ—Ç–º–µ–Ω–µ–Ω–Ω–æ–π –æ–ø–ª–∞—Ç—ã
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∏ webhook —á–µ—Ä–µ–∑ HMAC SHA256

### ‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç—Å—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞:
- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ÆKassa –∞–∫–∫–∞—É–Ω—Ç–∞ –∏ –ø–æ–ª—É—á–µ–Ω–∏–µ API –∫–ª—é—á–µ–π
- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–ª—é—á–µ–π –≤ `.env.local`
- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ webhook –≤ –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ –ÆKassa

## –°–æ–∑–¥–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

1. **`app/api/subscription/route.ts`**
   - GET: –ø–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–¥–ø–∏—Å–∫–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   - POST: –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏ (–¥–ª—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è)

2. **`app/api/subscription/webhook/route.ts`**
   - POST: webhook endpoint –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–±—ã—Ç–∏–π –æ—Ç –ø–ª–∞—Ç–µ–∂–Ω—ã—Ö –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤
   - –ì–æ—Ç–æ–≤ –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å–æ Stripe –∏–ª–∏ –ÆKassa

3. **`lib/payment/config.ts`**
   - –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø–ª–∞—Ç–µ–∂–Ω—ã—Ö –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤
   - –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–∞—Ä–∏—Ñ–Ω—ã—Ö –ø–ª–∞–Ω–æ–≤
   - –£—Ç–∏–ª–∏—Ç—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø–ª–∞—Ç–µ–∂–∞–º–∏

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏ –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

### –î–ª—è –ÆKassa (‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ):

1. ‚úÖ –ÆKassa SDK —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω:
```bash
pnpm add @yookassa/sdk
```

2. –î–æ–±–∞–≤–∏—Ç—å –≤ `.env.local`:
```env
PAYMENT_PROVIDER=yookassa
PAYMENT_SECRET_KEY=test_... (–∏–ª–∏ live_... –¥–ª—è production)
PAYMENT_SHOP_ID=–≤–∞—à_shop_id
PAYMENT_WEBHOOK_SECRET=... (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–ø–∏—Å–∏)
NEXT_PUBLIC_APP_URL=http://localhost:3000 (–¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏)
```

3. ‚úÖ API endpoint —Å–æ–∑–¥–∞–Ω:
   - `app/api/payment/create-session/route.ts` - —Å–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–µ–π —á–µ—Ä–µ–∑ –ÆKassa API
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç REST API –ÆKassa (`/v3/payments`)

4. ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏–π —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –≤ `app/api/subscription/webhook/route.ts`:
   - `payment.succeeded` - —É—Å–ø–µ—à–Ω–∞—è –æ–ø–ª–∞—Ç–∞ ‚Üí –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ premium
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ `subscription_tier` –∏ `premium_expires_at` –≤ –ë–î
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∏ webhook —á–µ—Ä–µ–∑ HMAC SHA256

5. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å webhook –≤ –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ –ÆKassa:
   - –ü–µ—Ä–µ–π–¥–∏—Ç–µ: https://yookassa.ru/my/ ‚Üí –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ‚Üí HTTP-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
   - –ù–∞–∂–º–∏—Ç–µ "–ü–æ–¥–∫–ª—é—á–∏—Ç—å HTTP-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è"
   - URL: `https://your-domain.com/api/subscription/webhook` (–¥–ª—è production)
   - –î–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ ngrok: `ngrok http 3000`
   - –°–æ–±—ã—Ç–∏—è: `payment.succeeded`, `payment.canceled`
   - –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

üìñ **–ü–æ–¥—Ä–æ–±–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è**: –°–º. `docs/YOOKASSA_SETUP.md`

### –î–ª—è –ÆKassa:

1. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ÆKassa SDK:
```bash
pnpm add @yookassa/sdk
```

2. –î–æ–±–∞–≤–∏—Ç—å –≤ `.env.local`:
```env
PAYMENT_PROVIDER=yookassa
PAYMENT_SECRET_KEY=live_... –∏–ª–∏ test_...
PAYMENT_SHOP_ID=your_shop_id
PAYMENT_WEBHOOK_SECRET=...
```

3. –°–æ–∑–¥–∞—Ç—å API endpoint –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞:
   - `app/api/payment/create-payment/route.ts`
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ÆKassa API –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞

4. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É —Å–æ–±—ã—Ç–∏–π –≤ `app/api/subscription/webhook/route.ts`:
   - `payment.succeeded` - —É—Å–ø–µ—à–Ω–∞—è –æ–ø–ª–∞—Ç–∞
   - `payment.canceled` - –æ—Ç–º–µ–Ω–∞ –æ–ø–ª–∞—Ç—ã

5. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å webhook –≤ –ÆKassa –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ:
   - URL: `https://your-domain.com/api/subscription/webhook`
   - –°–æ–±—ã—Ç–∏—è: `payment.succeeded`, `payment.canceled`

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

–ü–æ–¥–ø–∏—Å–∫–∏ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ —Ç–∞–±–ª–∏—Ü–µ `profiles`:
- `subscription_tier` - "basic" | "premium"
- `premium_expires_at` - –¥–∞—Ç–∞ –∏—Å—Ç–µ—á–µ–Ω–∏—è –ø—Ä–µ–º–∏—É–º –ø–æ–¥–ø–∏—Å–∫–∏ (TIMESTAMPTZ, NULL = –ø–æ—Å—Ç–æ—è–Ω–Ω–∞—è)
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å—Ç–µ—á–µ–Ω–∏—è –ø—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ `getUserSubscription()` –≤ `lib/subscription/check.ts`

## –¢–∞—Ä–∏—Ñ–Ω—ã–µ –ø–ª–∞–Ω—ã

–û–ø—Ä–µ–¥–µ–ª–µ–Ω—ã –≤ `lib/payment/config.ts`:
- `premium_monthly` - –ü—Ä–µ–º–∏—É–º –Ω–∞ –º–µ—Å—è—Ü (299‚ÇΩ)
- `premium_yearly` - –ü—Ä–µ–º–∏—É–º –Ω–∞ –≥–æ–¥ (2990‚ÇΩ)

## –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

‚úÖ **–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ**:
1. ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∏ webhook —á–µ—Ä–µ–∑ `stripe.webhooks.constructEvent()`
2. ‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ service role client –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–æ–∫ (–æ–±—Ö–æ–¥–∏—Ç RLS)
3. ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Å–µ—Ö –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –≤ API endpoints

‚ö†Ô∏è **–í–ê–ñ–ù–û –¥–ª—è production**:
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `sk_live_...` –¥–ª—è production (–Ω–µ —Ç–µ—Å—Ç–æ–≤—ã–π –∫–ª—é—á)
- –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π `NEXT_PUBLIC_APP_URL` –¥–ª—è production
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ webhook endpoint –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ HTTPS
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ `PAYMENT_WEBHOOK_SECRET` –ø—Ä–∞–≤–∏–ª—å–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–î–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:
- **Stripe**: Test mode —Å —Ç–µ—Å—Ç–æ–≤—ã–º–∏ –∫–∞—Ä—Ç–∞–º–∏
- **–ÆKassa**: Sandbox —Ä–µ–∂–∏–º –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

## –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

- [Stripe Webhooks](https://stripe.com/docs/webhooks)
- [–ÆKassa Webhooks](https://yookassa.ru/developers/using-api/webhooks)
