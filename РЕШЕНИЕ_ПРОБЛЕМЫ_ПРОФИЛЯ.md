# Решение проблемы создания профиля

## Проблема
Ошибка: "Failed to create profile after multiple attempts"

## Решение (выполнить по порядку)

### Шаг 1: Выполните SQL скрипты в Supabase

Откройте SQL Editor: https://supabase.com/dashboard/project/pklwfuyxumtjbgyqlxsf/sql

Выполните **В ТАКОМ ПОРЯДКЕ**:

1. **`scripts/005-fix-profile-policies.sql`** - исправляет RLS политики
2. **`scripts/006-fix-profile-creation-service-role.sql`** - создает функцию для обхода RLS

### Шаг 2: Проверьте логи

После выполнения скриптов:

1. Откройте консоль браузера (F12 → Console)
2. Попробуйте создать профиль снова
3. Найдите ошибку в консоли - там будет детальная информация

### Шаг 3: Альтернативное решение (если скрипты не помогли)

Если проблема сохраняется, возможно нужно временно отключить RLS для проверки:

```sql
-- ВРЕМЕННО отключить RLS для тестирования (не использовать в продакшене!)
ALTER TABLE profiles DISABLE ROW LEVEL SECURITY;
```

Если после этого профиль создается, значит проблема в политиках. Верните RLS обратно и проверьте политики:

```sql
ALTER TABLE profiles ENABLE ROW LEVEL SECURITY;

-- Проверьте политики
SELECT * FROM pg_policies WHERE tablename = 'profiles';
```

### Шаг 4: Проверьте триггер

Убедитесь, что триггер создает профиль автоматически:

```sql
-- Проверьте, что триггер существует
SELECT * FROM pg_trigger WHERE tgname = 'on_auth_user_created';

-- Проверьте функцию триггера
SELECT * FROM pg_proc WHERE proname = 'handle_new_user';
```

## Что было исправлено в коде

✅ Создан API endpoint `/api/profile/create` с улучшенной обработкой ошибок
✅ Добавлена функция базы данных `create_user_profile` с SECURITY DEFINER для обхода RLS
✅ Улучшена генерация уникального username
✅ Добавлено детальное логирование всех ошибок
✅ Обработка конфликтов primary key (профиль уже существует)

## Диагностика

Если проблема сохраняется, проверьте в консоли браузера:
- Какая именно ошибка возвращается (errorCode, hint, details)
- На какой попытке происходит ошибка
- Какой username пытается использоваться

Откройте Network tab в DevTools и проверьте ответ от `/api/profile/create` - там будет детальная информация об ошибке.
