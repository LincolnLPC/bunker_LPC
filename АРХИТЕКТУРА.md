# Архитектура приложения «Бункер Онлайн»

## Общая архитектура

```
┌─────────────────────────────────────────────────────────────────┐
│                         CLIENT (Next.js)                        │
│                                                                 │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐         │
│  │   Landing    │  │    Lobby     │  │    Game      │         │
│  │     Page     │  │    Pages     │  │    Room      │         │
│  └──────────────┘  └──────────────┘  └──────────────┘         │
│         │                 │                 │                   │
│         └─────────────────┼─────────────────┘                   │
│                           │                                     │
│         ┌─────────────────┴─────────────────┐                 │
│         │                                   │                 │
│  ┌──────────────┐                  ┌──────────────┐          │
│  │   React      │                  │    WebRTC    │          │
│  │  Components  │                  │   Hooks      │          │
│  └──────────────┘                  └──────────────┘          │
│         │                                   │                 │
│         │         ┌─────────────────────────┘                 │
│         │         │                                           │
│  ┌──────┴─────────┴──────────┐                               │
│  │   Custom Hooks            │                               │
│  │  - useGameState           │                               │
│  │  - useRealtimeGame        │                               │
│  │  - useWebRTC              │                               │
│  └───────────────┬───────────┘                               │
└──────────────────┼────────────────────────────────────────────┘
                   │
                   │ HTTP/WebSocket
                   │
┌──────────────────┼────────────────────────────────────────────┐
│         ┌────────┴────────┐                                   │
│         │   Next.js API   │                                   │
│         │    Routes       │                                   │
│         └────────┬────────┘                                   │
│                  │                                            │
│    ┌─────────────┼─────────────┐                             │
│    │             │             │                             │
│ ┌──┴──┐    ┌────┴────┐  ┌────┴────┐                         │
│ │Game │    │  Auth   │  │  Chat   │                         │
│ │API  │    │  API    │  │  API    │                         │
│ └──┬──┘    └────┬────┘  └────┬────┘                         │
│    │            │            │                               │
└────┼────────────┼────────────┼───────────────────────────────┘
     │            │            │
     └────────────┼────────────┘
                  │
     ┌────────────┴────────────┐
     │                         │
┌────┴────┐            ┌───────┴────────┐
│Supabase │            │  Payment API   │
│         │            │  (Stripe/ЮK)   │
│  ┌──────┴──────┐    └────────────────┘
│  │             │
│  │  PostgreSQL │
│  │  Database   │
│  │             │
│  │  Auth       │
│  │  Storage    │
│  │  Realtime   │
│  └──────┬──────┘
└─────────┼────────────────────────────────────┐
          │                                    │
          │                                    │
     ┌────┴─────┐                      ┌──────┴──────┐
     │   STUN   │                      │     TURN    │
     │  Server  │                      │   Server    │
     └──────────┘                      └─────────────┘
          │                                    │
          └──────────────┬─────────────────────┘
                         │
                    WebRTC Signaling
                         │
          ┌───────────────┼───────────────┐
          │               │               │
     ┌────┴────┐    ┌────┴────┐    ┌────┴────┐
     │Client A │◄───┤Supabase │───►│Client B │
     │         │    │Realtime │    │         │
     └─────────┘    └─────────┘    └─────────┘
```

## Структура базы данных

```
┌─────────────┐
│   profiles  │
│─────────────│
│ id (PK)     │
│ username    │
│ display_name│
│ avatar_url  │
│ sub_tier    │◄──────┐
│ games_played│       │
│ games_won   │       │
└──────┬──────┘       │
       │              │
       │              │
       │         ┌────┴─────┐
       │         │game_rooms│
       │         │──────────│
       │         │ id (PK)  │
       │         │ room_code│
       │         │ host_id  │───┐
       │         │ max_players│ │
       │         │ catastrophe│ │
       │         │ phase     │ │
       │         └─────┬─────┘ │
       │               │       │
       │               │       │
       └───────────────┼───────┘
                       │
                ┌──────┴──────┐
                │game_players │
                │─────────────│
                │ id (PK)     │
                │ room_id (FK)│
                │ user_id (FK)│
                │ slot        │
                │ name        │
                │ profession  │
                │ is_eliminated│
                └──────┬──────┘
                       │
        ┌──────────────┼──────────────┐
        │              │              │
┌───────┴──────┐ ┌────┴─────┐ ┌──────┴──────┐
│characteristics│ │  votes   │ │chat_messages│
│───────────────│ │──────────│ │─────────────│
│ id (PK)       │ │ id (PK)  │ │ id (PK)     │
│ player_id (FK)│ │ room_id  │ │ room_id     │
│ category      │ │ voter_id │ │ player_id   │
│ value         │ │ target_id│ │ message     │
│ is_revealed   │ │ round    │ │ type        │
└───────────────┘ └──────────┘ └─────────────┘
```

## Поток данных в игре

### Создание комнаты
```
Client → POST /api/game
       → Supabase: INSERT game_rooms
       → Generate room_code
       → Return room data
       → Client: Redirect to /game/[roomCode]
```

### Присоединение к игре
```
Client → POST /api/game/join
       → Supabase: Check room exists
       → Supabase: INSERT game_players
       → Supabase: Generate characteristics
       → Client: Join Realtime channel
       → Broadcast: player_join event
```

### Обновление игрового состояния
```
Host → API: Update game state
     → Supabase: UPDATE game_rooms
     → Supabase Realtime: Broadcast event
     → All clients: Receive update
     → UI: Re-render
```

### WebRTC соединение
```
Client A → Initialize local stream
        → Join Realtime channel
        → Create offer
        → Send offer via Realtime
        → Client B: Receive offer
        → Client B: Create answer
        → Client B: Send answer via Realtime
        → Client A: Receive answer
        → Exchange ICE candidates via Realtime
        → P2P connection established
```

## Компоненты системы

### Frontend (Next.js App Router)
```
app/
├── (landing)/
│   └── page.tsx          # Главная страница
├── auth/
│   ├── login/
│   └── signup/
├── lobby/
│   ├── page.tsx          # Лобби
│   ├── create/
│   └── join/
├── game/
│   └── [roomCode]/
│       └── page.tsx      # Игровая комната
└── api/
    └── game/
        ├── route.ts      # Создание/получение комнаты
        ├── join/
        ├── start/
        ├── vote/
        └── eliminate/

components/
├── game/                 # Игровые компоненты
│   ├── player-grid.tsx
│   ├── player-card.tsx
│   ├── voting-panel.tsx
│   ├── chat-panel.tsx
│   └── ...
└── ui/                   # Базовые UI компоненты

hooks/
├── use-game-state.ts     # Управление состоянием игры
├── use-realtime-game.ts  # Real-time синхронизация
└── use-webrtc.ts         # WebRTC управление
```

### Backend (Supabase)
```
Supabase/
├── PostgreSQL Database
│   ├── profiles
│   ├── game_rooms
│   ├── game_players
│   ├── player_characteristics
│   ├── votes
│   └── chat_messages
│
├── Auth
│   ├── User management
│   └── Session handling
│
├── Realtime
│   ├── Broadcast channels
│   └── Presence tracking
│
└── Storage
    └── Avatar images
```

## Технологический стек

### Frontend
- **Framework**: Next.js 16 (App Router)
- **Language**: TypeScript
- **UI**: React 19, Tailwind CSS, shadcn/ui
- **State**: React Hooks + Supabase Realtime
- **WebRTC**: Browser WebRTC API

### Backend
- **BaaS**: Supabase
- **Database**: PostgreSQL
- **Auth**: Supabase Auth
- **Real-time**: Supabase Realtime (WebSocket)
- **Storage**: Supabase Storage

### Инфраструктура
- **Hosting**: Vercel (предположительно)
- **CDN**: Vercel Edge Network
- **STUN/TURN**: Публичные серверы или собственные

### Платежи (планируется)
- **Payment Provider**: Stripe или ЮKassa
- **Webhooks**: Next.js API routes

## Безопасность

### Уровни защиты
1. **Row Level Security (RLS)** в PostgreSQL
2. **Auth middleware** для защищенных маршрутов
3. **API validation** с Zod
4. **CORS** настройки
5. **Rate limiting** (планируется)

### RLS политики
- Пользователи видят только свои профили (кроме публичных данных)
- Игроки видят только характеристики своей комнаты
- Ведущий может управлять только своей комнатой
- Голоса скрыты до окончания раунда

## Масштабируемость

### Текущие ограничения
- Supabase Realtime: до 200 одновременных подключений на канал
- PostgreSQL: зависит от плана Supabase
- WebRTC: зависит от STUN/TURN серверов

### Потенциальные улучшения
- Redis для кеширования частых запросов
- CDN для статических ресурсов
- Dedicated TURN серверы для WebRTC
- Микросервисная архитектура (если вырастет)

---

**Версия документа**: 1.0
**Дата**: 2024
